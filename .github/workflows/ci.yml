name: Node.js CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev
    strategy:
      matrix:
        node-version: [22.x]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci
      - run: npm run lint
      - run: npm run build --if-present

      - name: "IaC"
        uses: ./.github/actions/iac
        with:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
          PULUMI_STACK: ${{ vars.PULUMI_STACK }}
          CLOUD_URL: ${{ vars.CLOUD_URL }}
          PROJECT_ID: ${{ vars.PROJECT_ID }}
          GCP_REGION: ${{ vars.GCP_REGION }}
          NAME_PREFIX: ${{ vars.NAME_PREFIX }}

      - name: "migrate"
        uses: ./.github/actions/migrate
        with:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
          PROJECT_ID: ${{ vars.PROJECT_ID }}
          NAME_PREFIX: ${{ vars.NAME_PREFIX }}
          INSTANCE_NAME: ${{ vars.INSTANCE_NAME }}
          DATABASE_NAME: ${{ vars.DATABASE_NAME }}
          SCHEMA_NAME: ${{ vars.SCHEMA_NAME }}

      - name: "docker-build"
        uses: ./.github/actions/docker
        with:
          image-name: api
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
          PROJECT_ID: ${{ vars.PROJECT_ID }}
          GCP_REGION: ${{ vars.GCP_REGION }}
          NAME_PREFIX: ${{ vars.NAME_PREFIX }}
